<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My PokÃ©mon Collection</title>
    <link rel="stylesheet" href="css/style-display.css">
    <style>
        .deck-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .deck-title {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8em;
            font-weight: bold;
        }

        .deck-slots {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .deck-slot {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            padding: 10px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .deck-slot:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
        }

        .deck-slot.occupied {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #4CAF50;
        }

        .deck-slot-number {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
        }

        .deck-slot.empty {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
        }

        .deck-card-image {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 5px;
        }

        .deck-card-name {
            font-size: 0.8em;
            font-weight: bold;
            text-align: center;
            color: #333;
            margin-bottom: 2px;
        }

        .deck-card-stats {
            font-size: 0.7em;
            color: #666;
            text-align: center;
        }

        .remove-from-deck {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .collection-section {
            margin-top: 50px;
        }

        .collection-section h2 {
            text-align: center;
            margin: 40px 0 20px 0;
            color: #333;
            font-size: 2em;
            font-weight: bold;
        }

        .assign-to-deck {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            width: 100%;
        }

        .assign-to-deck:hover {
            background: #45a049;
        }

        .already-in-deck {
            background: #666;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            margin-top: 10px;
            width: 100%;
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-content">
            <h1 class="nav-logo">PokÃ©mon Collection</h1>
            <div class="nav-actions">
                <span class="user-welcome" id="userWelcome"></span>
                <span class="pokecoins-display" id="pokecoinsDisplay" style="margin-right: 15px; font-weight: bold; color: #ffd700;">ðŸ’° <span id="pokecoinsValue">0</span> PokeCoins</span>
                <button onclick="window.location.href='display.html'" class="nav-btn">
                    Browse Cards
                </button>
                <button onclick="signOut()" class="nav-btn signout-btn">
                    Sign Out
                </button>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Deck Section -->
        <div class="deck-section">
            <h2 class="deck-title">My Battle Deck (6 Slots)</h2>
            <div class="deck-slots" id="deckSlots">
                <!-- Deck slots will be populated here -->
            </div>
        </div>

        <!-- Collection Section -->
        <div class="collection-section">
            <h2>My PokÃ©mon Collection</h2>
            <div class="cards-grid" id="collectionContainer">
                <!-- Collection cards will be populated here -->
            </div>
            <div class="empty-state" id="emptyCollectionState" style="display: none;">
                <div class="empty-icon">ðŸ“¦</div>
                <h2>No Cards in Collection</h2>
                <p>Start building your collection by purchasing PokÃ©mon cards!</p>
                <button onclick="window.location.href='display.html'" class="empty-btn">
                    Browse Cards
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentUserCards = [];
        let currentDeck = {};

        function signOut() {
            localStorage.clear();
            window.location.href = "landing.html";
        }

        function showTab(tabName) {
            // This function is no longer needed since we removed tabs
        }

        // Display username and manage role-based UI
        document.addEventListener("DOMContentLoaded", function () {
            const username = localStorage.getItem("username");
            const role = localStorage.getItem("role");
            const pokecoins = localStorage.getItem("pokecoins");

            if (!username) {
                window.location.href = "landing.html";
            } else {
                document.getElementById("userWelcome").textContent = `Welcome, ${username}!`;
                document.getElementById("pokecoinsValue").textContent = pokecoins || "0";
            }

            // Load both deck and collection
            loadDeck();
            loadCollection();
        });

        function loadDeck() {
            fetch('/pokemon_trading/fetch_user_deck.php')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentDeck = data.deck;
                        renderDeck();
                    } else {
                        alert('Error loading deck: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading deck');
                });
        }

        function renderDeck() {
            const deckSlots = document.getElementById('deckSlots');
            deckSlots.innerHTML = '';

            for (let i = 1; i <= 6; i++) {
                const slotDiv = document.createElement('div');
                slotDiv.className = 'deck-slot';
                slotDiv.dataset.slot = i;

                const slotNumber = document.createElement('div');
                slotNumber.className = 'deck-slot-number';
                slotNumber.textContent = i;
                slotDiv.appendChild(slotNumber);

                if (currentDeck[i]) {
                    slotDiv.classList.add('occupied');
                    const card = currentDeck[i];

                    const img = document.createElement('img');
                    img.src = 'images/' + card.image_url;
                    img.alt = card.name;
                    img.className = 'deck-card-image';
                    slotDiv.appendChild(img);

                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'deck-card-name';
                    nameDiv.textContent = card.name;
                    slotDiv.appendChild(nameDiv);

                    const statsDiv = document.createElement('div');
                    statsDiv.className = 'deck-card-stats';
                    statsDiv.textContent = `HP: ${card.health} | PWR: ${card.power}`;
                    slotDiv.appendChild(statsDiv);

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-from-deck';
                    removeBtn.textContent = 'Ã—';
                    removeBtn.onclick = (e) => {
                        e.stopPropagation();
                        removeFromDeck(i);
                    };
                    slotDiv.appendChild(removeBtn);
                } else {
                    slotDiv.classList.add('empty');
                    slotDiv.innerHTML += '<div>Empty Slot</div><div>Click to assign</div>';
                }

                slotDiv.onclick = () => {
                    if (!currentDeck[i]) {
                        assignToDeck(i);
                    }
                };

                deckSlots.appendChild(slotDiv);
            }
        }

        function loadCollection() {
            fetch('/pokemon_trading/fetch_user_cards.php')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentUserCards = data.cards;
                        renderCollection();
                    } else {
                        alert('Error loading collection: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading collection');
                });
        }

        function renderCollection() {
            const container = document.getElementById('collectionContainer');
            const emptyState = document.getElementById('emptyCollectionState');

            if (currentUserCards.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.innerHTML = '';

            currentUserCards.forEach(card => {
                const imagePath = card.image_url ? `images/${card.image_url}` : "images/default.png";
                const typeClass = card.type ? card.type.toLowerCase() : "normal";

                // Check if this card is already in the deck
                let isInDeck = false;
                let deckSlot = null;
                for (let i = 1; i <= 6; i++) {
                    if (currentDeck[i] && currentDeck[i].ownership_id == card.ownership_id) {
                        isInDeck = true;
                        deckSlot = i;
                        break;
                    }
                }

                const buttonHtml = isInDeck
                    ? `<button class="already-in-deck" disabled>In Deck (Slot ${deckSlot})</button>`
                    : `<button class="assign-to-deck" onclick="assignCardToDeck(${card.ownership_id}, '${card.name}')">Add to Deck</button>`;

                const cardElement = document.createElement("div");
                cardElement.className = `pokemon-card type-${typeClass}`;
                cardElement.innerHTML = `
                    <div class="card-inner">
                        <div class="card-header">
                            <h3 class="card-name">${card.name || "Unknown"}</h3>
                            <span class="card-hp">${card.health || "0"} HP</span>
                        </div>

                        <div class="card-image-container">
                            <img src="${imagePath}" alt="${card.name}" class="card-image" />
                        </div>

                        <div class="card-type">
                            <span class="type-badge type-${typeClass}">${card.type || "Normal"}</span>
                        </div>

                        <div class="card-stats">
                            <div class="stat">
                                <span class="stat-label">Power</span>
                                <span class="stat-value">${card.power || "0"}</span>
                            </div>
                        </div>

                        <div class="card-actions">
                            ${buttonHtml}
                        </div>
                    </div>
                `;
                container.appendChild(cardElement);
            });
        }

        function assignToDeck(slot) {
            // Since we removed tabs, this function is no longer needed
            // Users can directly click "Add to Deck" buttons on cards below
        }

        function assignCardToDeck(ownershipId, cardName) {
            // Check if this card is already in the deck
            for (let i = 1; i <= 6; i++) {
                if (currentDeck[i] && currentDeck[i].ownership_id == ownershipId) {
                    alert(`${cardName} is already in your deck!`);
                    return;
                }
            }

            // Find which slot is empty or let user choose
            const emptySlots = [];
            for (let i = 1; i <= 6; i++) {
                if (!currentDeck[i]) {
                    emptySlots.push(i);
                }
            }

            if (emptySlots.length === 0) {
                alert('Your deck is full! Remove a card first.');
                return;
            }

            // For simplicity, assign to first empty slot
            const slot = emptySlots[0];

            fetch('/pokemon_trading/update_deck_slot.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    slot: slot,
                    ownership_id: ownershipId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Automatically refresh the UI without alert
                    loadDeck(); // Refresh deck display
                    loadCollection(); // Refresh collection to show updated state
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating deck');
            });
        }

        function removeFromDeck(slot) {
            if (confirm(`Remove card from deck slot ${slot}?`)) {
                fetch('/pokemon_trading/update_deck_slot.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        slot: slot,
                        ownership_id: null
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        loadDeck(); // Refresh deck display
                        loadCollection(); // Refresh collection
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating deck');
                });
            }
        }
    </script>
</body>
</html>